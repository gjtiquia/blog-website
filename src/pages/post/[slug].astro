---
import type { InferGetStaticParamsType, InferGetStaticPropsType } from "astro";
import { PortableText } from "astro-portabletext";
import { formatDate, getAuthor, getPost, getPosts, urlFor } from "@src/sanity";
import BaseLayout from "@src/layouts/BaseLayout.astro";
import { ImageComponent } from "@src/components";
import { CenterProseContainer } from "@src/components/CenterProseContainer";

export async function getStaticPaths() {
    const posts = await getPosts();

    return posts.map((post) => ({
        params: {
            slug: post.slug.current,
        },
        props: {
            authorRef: post.author ? post.author._ref : "",
        },
    }));
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
const { slug } = Astro.params as Params;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;
const { authorRef } = Astro.props as Props;

const post = await getPost(slug);
const author = await getAuthor(authorRef);
---

<BaseLayout title={post.title ? post.title : "Untitled"} titlePrefix={""}>
    <CenterProseContainer>
        <article
            class="prose prose-h1:mb-2 prose-hr:mt-2 prose-hr:mb-8 prose-img:rounded-xl prose-img:mx-auto prose-code:before:content-none prose-code:after:content-none"
        >
            <h1>{post.title}</h1>
            <div
                class="not-prose mb-2 flex flex-row justify-between text-gray-500"
            >
                <p>{"By " + author.name}</p>
                <p>
                    {formatDate(post.publishedAt)}
                </p>
            </div>
            <div class="not-prose">
                <a
                    href="/tags"
                    class="bg-slate-400 hover:bg-slate-500 active:bg-slate-600 text-slate-50 px-3 py-1 text-sm rounded-full"
                >
                    Tag 1
                </a>
            </div>
            <!-- <hr /> -->
            <PortableText
                value={post.body}
                components={{
                    type: {
                        image: ImageComponent,
                    },
                }}
            />
        </article>
    </CenterProseContainer>
</BaseLayout>
